<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients - Rizalcare EMR</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 10px; padding: 20px; max-width: 900px; width: 95%; max-height: 95vh; overflow-y: auto; }
    .modal-close { float: right; font-size: 28px; cursor: pointer; color: #999; line-height: 1; }
    .modal-close:hover { color: #333; }
    .modal h2 { margin-bottom: 15px; font-size: 20px; clear: both; }
    .modal h3 { margin: 15px 0 10px 0; font-size: 16px; color: #666; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .form-group { margin-bottom: 10px; }
    .form-group label { font-size: 13px; margin-bottom: 3px; display: block; }
    .form-group input, .form-group select { padding: 8px; font-size: 13px; width: 100%; }
    #patientHistoryModal .modal-content { max-width: 1100px; }
    #patientHistoryModal table { width: 100%; border-collapse: collapse; }
    #patientHistoryModal table th { background: #f5f5f5; padding: 8px; text-align: left; font-size: 13px; }
    #patientHistoryModal table td { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
    @media (max-width: 768px) { 
      .form-row { grid-template-columns: 1fr; }
      #patientHistoryModal .modal-content > div:first-of-type { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="main-app">
    <nav class="top-nav">
      <div class="nav-left">
        <div class="clinic-name">üè• Rizalcare Medical Clinic</div>
      </div>
      <div class="nav-right">
        <span id="userDisplay"></span>
        <button onclick="handleLogout()" class="btn btn-secondary btn-sm">Logout</button>
      </div>
    </nav>

    <div class="main-layout">
      <aside class="sidebar">
        <ul class="menu">
          <li class="menu-item"><a href="/dashboard.html">üìä Dashboard</a></li>
          <li class="menu-item active"><a href="/patients.html">üë• Patients</a></li>
          <li class="menu-item"><a href="/appointments.html">üìÖ Appointments</a></li>
          <li class="menu-item"><a href="/consultations.html">ü©∫ Consultations</a></li>
          <li class="menu-item"><a href="/doctors.html">üë®‚Äç‚öïÔ∏è Doctors</a></li>
          <li class="menu-item"><a href="/items.html">üíä Items & Pricing</a></li>
        </ul>
      </aside>

      <main class="content-area">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h1>Patient Management</h1>
          <div style="display: flex; gap: 10px;">
            <button onclick="exportToCSV()" class="btn btn-success">üì• Export CSV</button>
            <button onclick="document.getElementById('csvFileInput').click()" class="btn btn-success">üì§ Import CSV</button>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
            <button onclick="openPatientModal()" class="btn btn-primary">+ Register New Patient</button>
          </div>
        </div>

        <div class="card">
          <div class="form-row">
            <div class="form-group">
              <label>Search Patient</label>
              <input type="text" id="patientSearch" placeholder="Type patient name, ID, or contact..." oninput="searchPatients()">
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
              <button onclick="loadAllPatients()" class="btn btn-secondary">Show All Patients</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Patient List</h3>
          <table>
            <thead>
              <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Gender</th>
                <th>Contact</th>
                <th>Type</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="patientListBody">
              <tr><td colspan="6" style="text-align: center; color: #999;">Click "Show All Patients" to view</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- Patient History Modal -->
  <div id="patientHistoryModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeHistoryModal()">&times;</span>
      <h2 id="historyPatientName">Patient History</h2>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="card" style="margin: 0;">
          <h3 style="margin-top: 0;">Personal Information</h3>
          <div id="historyPersonalInfo"></div>
        </div>
        <div class="card" style="margin: 0;">
          <h3 style="margin-top: 0;">Medical Information</h3>
          <div id="historyMedicalInfo"></div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-top: 0;">Emergency Contact</h3>
        <div id="historyEmergencyInfo"></div>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-top: 0;">Appointments History</h3>
        <div id="historyAppointments">Loading...</div>
      </div>

      <div class="card">
        <h3 style="margin-top: 0;">Consultation History</h3>
        <div id="historyConsultations">Loading...</div>
      </div>

      <div style="margin-top: 15px;">
        <button onclick="closeHistoryModal()" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Registration Modal -->
  <div id="patientModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closePatientModal()">&times;</span>
      <h2>Register New Patient</h2>
      <form id="patientForm" onsubmit="handlePatientSubmit(event)">
        <h3>Personal Information</h3>
        <div class="form-row">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" name="firstName" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" name="lastName" required>
          </div>
          <div class="form-group">
            <label>Date of Birth *</label>
            <input type="date" name="dateOfBirth" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Gender *</label>
            <select name="gender" required>
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label>Contact Number *</label>
            <input type="tel" name="contactNumber" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="grid-column: 1 / -1;">
            <label>Address</label>
            <input type="text" name="address">
          </div>
        </div>
        
        <h3>Medical Information</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Blood Type</label>
            <select name="bloodType">
              <option value="">Select</option>
              <option value="A+">A+</option>
              <option value="A-">A-</option>
              <option value="B+">B+</option>
              <option value="B-">B-</option>
              <option value="AB+">AB+</option>
              <option value="AB-">AB-</option>
              <option value="O+">O+</option>
              <option value="O-">O-</option>
            </select>
          </div>
          <div class="form-group">
            <label>Patient Type</label>
            <select name="patientType">
              <option value="New">New Patient</option>
              <option value="Returning">Returning</option>
            </select>
          </div>
          <div class="form-group">
            <label>Known Allergies</label>
            <input type="text" name="allergies" placeholder="e.g., Penicillin">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="grid-column: 1 / -1;">
            <label>Medical History</label>
            <input type="text" name="medicalHistory" placeholder="Previous conditions, surgeries, medications...">
          </div>
        </div>
        
        <h3>Emergency Contact</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Emergency Contact Name</label>
            <input type="text" name="emergencyContact" placeholder="Full name">
          </div>
          <div class="form-group">
            <label>Emergency Contact Number</label>
            <input type="tel" name="emergencyNumber" placeholder="09XXXXXXXXX">
          </div>
          <div class="form-group">
            <!-- Empty space for alignment -->
          </div>
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button type="submit" class="btn btn-primary">Register Patient</button>
          <button type="button" onclick="closePatientModal()" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
      <div id="patientFormMessage"></div>
    </div>
  </div>

  <script>
    fetch('/api/session').then(r => r.json()).then(user => {
      if (!user) { window.location.href = '/'; return; }
      document.getElementById('userDisplay').textContent = user.name + ' (' + user.role + ')';
    });

    function handleLogout() {
      fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/');
    }

    function openPatientModal() {
      document.getElementById('patientModal').classList.add('active');
      document.getElementById('patientForm').reset();
      document.getElementById('patientFormMessage').innerHTML = '';
    }

    function closePatientModal() {
      document.getElementById('patientModal').classList.remove('active');
    }

    function handlePatientSubmit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const patientData = {};
      formData.forEach((value, key) => { patientData[key] = value; });
      
      document.getElementById('patientFormMessage').innerHTML = '<div class="success-message">Registering...</div>';
      
      fetch('/api/patients/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patientData)
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          document.getElementById('patientFormMessage').innerHTML = 
            '<div class="success-message">‚úì Patient registered! ID: ' + result.patientId + '</div>';
          event.target.reset();
          setTimeout(() => { closePatientModal(); loadAllPatients(); }, 1500);
        } else {
          document.getElementById('patientFormMessage').innerHTML = 
            '<div class="error-message">Error: ' + result.message + '</div>';
        }
      })
      .catch(error => {
        document.getElementById('patientFormMessage').innerHTML = 
          '<div class="error-message">Connection error</div>';
      });
    }

    function loadAllPatients() {
      document.getElementById('patientListBody').innerHTML = 
        '<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';
      
      fetch('/api/patients/all')
        .then(r => r.json())
        .then(patients => {
          const tbody = document.getElementById('patientListBody');
          if (!patients || patients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No patients yet</td></tr>';
            return;
          }
          
          let html = '';
          patients.forEach(p => {
            html += '<tr>';
            html += '<td>' + p.patientId + '</td>';
            html += '<td>' + p.firstName + ' ' + p.lastName + '</td>';
            html += '<td>' + p.gender + '</td>';
            html += '<td>' + p.contactNumber + '</td>';
            html += '<td>' + p.patientType + '</td>';
            html += '<td><button onclick="viewPatient(\'' + p.patientId + '\')" class="btn btn-sm btn-primary">View</button></td>';
            html += '</tr>';
          });
          tbody.innerHTML = html;
        });
    }

    function searchPatients() {
      const term = document.getElementById('patientSearch').value;
      if (term.length < 2) {
        document.getElementById('patientListBody').innerHTML = 
          '<tr><td colspan="6" style="text-align: center; color: #999;">Type at least 2 characters</td></tr>';
        return;
      }
      
      fetch('/api/patients/search/' + encodeURIComponent(term))
        .then(r => r.json())
        .then(patients => {
          const tbody = document.getElementById('patientListBody');
          if (!patients || patients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No patients found</td></tr>';
            return;
          }
          
          let html = '';
          patients.forEach(p => {
            html += '<tr>';
            html += '<td>' + p.patientId + '</td>';
            html += '<td>' + p.firstName + ' ' + p.lastName + '</td>';
            html += '<td>' + p.gender + '</td>';
            html += '<td>' + p.contactNumber + '</td>';
            html += '<td>' + p.patientType + '</td>';
            html += '<td><button onclick="viewPatient(\'' + p.patientId + '\')" class="btn btn-sm btn-primary">View</button></td>';
            html += '</tr>';
          });
          tbody.innerHTML = html;
        });
    }

    function viewPatient(patientId) {
      document.getElementById('patientHistoryModal').classList.add('active');
      
      // Load patient details
      fetch('/api/patients/' + patientId)
        .then(r => r.json())
        .then(patient => {
          if (!patient) {
            alert('Patient not found');
            closeHistoryModal();
            return;
          }
          
          document.getElementById('historyPatientName').textContent = 
            patient.firstName + ' ' + patient.lastName + ' (' + patient.patientId + ')';
          
          // Personal Info
          document.getElementById('historyPersonalInfo').innerHTML = `
            <div style="margin-bottom: 8px;"><strong>Full Name:</strong> ${patient.firstName} ${patient.lastName}</div>
            <div style="margin-bottom: 8px;"><strong>Date of Birth:</strong> ${patient.dateOfBirth || 'N/A'}</div>
            <div style="margin-bottom: 8px;"><strong>Gender:</strong> ${patient.gender || 'N/A'}</div>
            <div style="margin-bottom: 8px;"><strong>Contact:</strong> ${patient.contactNumber || 'N/A'}</div>
            <div style="margin-bottom: 8px;"><strong>Email:</strong> ${patient.email || 'N/A'}</div>
            <div style="margin-bottom: 8px;"><strong>Address:</strong> ${patient.address || 'N/A'}</div>
            <div style="margin-bottom: 8px;"><strong>Patient Type:</strong> ${patient.patientType || 'N/A'}</div>
          `;
          
          // Medical Info
          document.getElementById('historyMedicalInfo').innerHTML = `
            <div style="margin-bottom: 8px;"><strong>Blood Type:</strong> ${patient.bloodType || 'N/A'}</div>
            <div style="margin-bottom: 8px;"><strong>Allergies:</strong> ${patient.allergies || 'None'}</div>
            <div style="margin-bottom: 8px;"><strong>Medical History:</strong> ${patient.medicalHistory || 'None'}</div>
          `;
          
          // Emergency Contact
          document.getElementById('historyEmergencyInfo').innerHTML = `
            <div style="margin-bottom: 8px;"><strong>Contact Person:</strong> ${patient.emergencyContact || 'N/A'}</div>
            <div style="margin-bottom: 8px;"><strong>Contact Number:</strong> ${patient.emergencyNumber || 'N/A'}</div>
          `;
        });
      
      // Load appointments
      fetch('/api/appointments/patient/' + patientId)
        .then(r => r.json())
        .then(appointments => {
          const div = document.getElementById('historyAppointments');
          if (!appointments || appointments.length === 0) {
            div.innerHTML = '<p style="color: #999;">No appointments found</p>';
            return;
          }
          
          let html = '<table style="width: 100%;"><thead><tr><th>Date</th><th>Time</th><th>Doctor</th><th>Purpose</th><th>Status</th></tr></thead><tbody>';
          appointments.forEach(apt => {
            html += '<tr>';
            html += '<td>' + apt.appointmentDate + '</td>';
            html += '<td>' + apt.appointmentTime + '</td>';
            html += '<td>' + apt.doctorName + '</td>';
            html += '<td>' + apt.purpose + '</td>';
            html += '<td>' + apt.status + '</td>';
            html += '</tr>';
          });
          html += '</tbody></table>';
          div.innerHTML = html;
        })
        .catch(() => {
          document.getElementById('historyAppointments').innerHTML = '<p style="color: #999;">No appointments found</p>';
        });
      
      // Load consultations
      fetch('/api/consultations/patient/' + patientId)
        .then(r => r.json())
        .then(consultations => {
          const div = document.getElementById('historyConsultations');
          if (!consultations || consultations.length === 0) {
            div.innerHTML = '<p style="color: #999;">No consultations found</p>';
            return;
          }
          
          let html = '';
          consultations.forEach(con => {
            const date = new Date(con.consultationDate).toLocaleDateString();
            const vitals = JSON.parse(con.vitalSigns || '{}');
            
            html += '<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #4A90E2;">Consultation - ' + date + '</h4>';
            html += '<p><strong>Doctor:</strong> ' + con.doctorName + '</p>';
            html += '<p><strong>Chief Complaint:</strong> ' + con.chiefComplaint + '</p>';
            
            if (vitals.bp || vitals.temp || vitals.hr) {
              html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0; background: white; padding: 10px; border-radius: 4px;">';
              if (vitals.bp) html += '<div><small style="color: #666;">BP:</small><br><strong>' + vitals.bp + '</strong></div>';
              if (vitals.temp) html += '<div><small style="color: #666;">Temp:</small><br><strong>' + vitals.temp + '¬∞C</strong></div>';
              if (vitals.hr) html += '<div><small style="color: #666;">HR:</small><br><strong>' + vitals.hr + ' bpm</strong></div>';
              if (vitals.weight) html += '<div><small style="color: #666;">Weight:</small><br><strong>' + vitals.weight + ' kg</strong></div>';
              html += '</div>';
            }
            
            html += '<p><strong>Diagnosis:</strong> ' + con.diagnosis + '</p>';
            html += '<p><strong>Treatment Plan:</strong> ' + con.treatmentPlan + '</p>';
            
            if (con.prescription) {
              html += '<p><strong>Prescription:</strong></p>';
              html += '<pre style="background: white; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-size: 13px;">' + con.prescription + '</pre>';
            }
            
            if (con.followUpDate) {
              html += '<p><strong>Follow-up Date:</strong> ' + con.followUpDate + '</p>';
            }
            
            html += '</div>';
          });
          div.innerHTML = html;
        })
        .catch(() => {
          document.getElementById('historyConsultations').innerHTML = '<p style="color: #999;">No consultations found</p>';
        });
    }

    function closeHistoryModal() {
      document.getElementById('patientHistoryModal').classList.remove('active');
    }

    // CSV Export Function
    function exportToCSV() {
      fetch('/api/patients/all')
        .then(r => r.json())
        .then(patients => {
          if (!patients || patients.length === 0) {
            alert('No patients to export');
            return;
          }

          // Create CSV header
          const headers = [
            'Patient ID', 'First Name', 'Last Name', 'Date of Birth', 'Gender',
            'Contact Number', 'Email', 'Address', 'Blood Type', 'Allergies',
            'Medical History', 'Emergency Contact', 'Emergency Number', 'Patient Type', 'Status'
          ];
          let csv = headers.join(',') + '\n';

          // Add data rows
          patients.forEach(patient => {
            // Fetch full patient details
            fetch('/api/patients/' + patient.patientId)
              .then(r => r.json())
              .then(p => {
                const row = [
                  p.patientId,
                  '"' + (p.firstName || '').replace(/"/g, '""') + '"',
                  '"' + (p.lastName || '').replace(/"/g, '""') + '"',
                  p.dateOfBirth || '',
                  p.gender || '',
                  p.contactNumber || '',
                  p.email || '',
                  '"' + (p.address || '').replace(/"/g, '""') + '"',
                  p.bloodType || '',
                  '"' + (p.allergies || '').replace(/"/g, '""') + '"',
                  '"' + (p.medicalHistory || '').replace(/"/g, '""') + '"',
                  '"' + (p.emergencyContact || '').replace(/"/g, '""') + '"',
                  p.emergencyNumber || '',
                  p.patientType || '',
                  'Active'
                ];
                csv += row.join(',') + '\n';

                // Download after last patient
                if (csv.split('\n').length - 1 === patients.length + 1) {
                  downloadCSV(csv);
                }
              });
          });
        });
    }

    function downloadCSV(csv) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'patients_' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      alert('Patients exported successfully!');
    }

    // CSV Import Function
    function importFromCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        
        if (lines.length < 2) {
          alert('CSV file is empty or invalid');
          return;
        }

        // Skip header row
        const dataLines = lines.slice(1).filter(line => line.trim());
        
        if (dataLines.length === 0) {
          alert('No data found in CSV file');
          return;
        }

        const patientsToImport = [];
        let errors = [];

        dataLines.forEach((line, index) => {
          const fields = parseCSVLine(line);
          
          if (fields.length < 5) {
            errors.push('Line ' + (index + 2) + ': Insufficient fields');
            return;
          }

          const patientData = {
            firstName: fields[1] || '',
            lastName: fields[2] || '',
            dateOfBirth: fields[3] || '',
            gender: fields[4] || '',
            contactNumber: fields[5] || '',
            email: fields[6] || '',
            address: fields[7] || '',
            bloodType: fields[8] || '',
            allergies: fields[9] || '',
            medicalHistory: fields[10] || '',
            emergencyContact: fields[11] || '',
            emergencyNumber: fields[12] || '',
            patientType: fields[13] || 'New'
          };

          // Validate required fields
          if (!patientData.firstName || !patientData.lastName || !patientData.dateOfBirth || !patientData.gender) {
            errors.push('Line ' + (index + 2) + ': Missing required fields (First Name, Last Name, DOB, Gender)');
            return;
          }

          patientsToImport.push(patientData);
        });

        if (errors.length > 0) {
          alert('Import errors:\n' + errors.join('\n'));
          return;
        }

        if (patientsToImport.length === 0) {
          alert('No valid patients to import');
          return;
        }

        if (!confirm('Import ' + patientsToImport.length + ' patients? This will add new patients to the database.')) {
          return;
        }

        // Import patients
        importPatientsBatch(patientsToImport, 0);
      };

      reader.readAsText(file);
      event.target.value = '';
    }

    function parseCSVLine(line) {
      const fields = [];
      let field = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            field += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          fields.push(field.trim());
          field = '';
        } else {
          field += char;
        }
      }
      fields.push(field.trim());
      return fields;
    }

    function importPatientsBatch(patients, index) {
      if (index >= patients.length) {
        alert('Import completed! ' + patients.length + ' patients imported successfully.');
        loadAllPatients();
        return;
      }

      fetch('/api/patients/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patients[index])
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          importPatientsBatch(patients, index + 1);
        } else {
          alert('Error importing patient at line ' + (index + 2) + ': ' + result.message);
        }
      })
      .catch(error => {
        alert('Error importing patient at line ' + (index + 2) + ': ' + error.message);
      });
    }
  </script>
</body>
</html>

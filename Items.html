<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Items & Pricing - Rizalcare EMR</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 10px; padding: 20px; max-width: 600px; width: 95%; }
    .modal-close { float: right; font-size: 28px; cursor: pointer; color: #999; line-height: 1; }
    .modal-close:hover { color: #333; }
    .modal h2 { margin-bottom: 15px; font-size: 20px; clear: both; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .form-group { margin-bottom: 10px; }
    .form-group label { font-size: 13px; margin-bottom: 3px; display: block; }
    .form-group input, .form-group select, .form-group textarea { padding: 8px; font-size: 13px; width: 100%; }
    .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .filter-tab { padding: 10px 20px; border: none; background: #f0f0f0; cursor: pointer; border-radius: 5px; }
    .filter-tab.active { background: var(--primary-color); color: white; }
  </style>
</head>
<body>
  <div class="main-app">
    <nav class="top-nav">
      <div class="nav-left">
        <div class="clinic-name">üè• Rizalcare Medical Clinic</div>
      </div>
      <div class="nav-right">
        <span id="userDisplay"></span>
        <button onclick="handleLogout()" class="btn btn-secondary btn-sm">Logout</button>
      </div>
    </nav>

    <div class="main-layout">
      <aside class="sidebar">
        <ul class="menu">
          <li class="menu-item"><a href="/dashboard.html">üìä Dashboard</a></li>
          <li class="menu-item"><a href="/patients.html">üë• Patients</a></li>
          <li class="menu-item"><a href="/appointments.html">üìÖ Appointments</a></li>
          <li class="menu-item"><a href="/consultations.html">ü©∫ Consultations</a></li>
          <li class="menu-item"><a href="/doctors.html">üë®‚Äç‚öïÔ∏è Doctors</a></li>
          <li class="menu-item active"><a href="/items.html">üíä Items & Pricing</a></li>
        </ul>
      </aside>

      <main class="content-area">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h1>Items & Pricing Management</h1>
          <div style="display: flex; gap: 10px;">
            <button onclick="exportToCSV()" class="btn btn-success">üì• Export CSV</button>
            <button onclick="document.getElementById('csvFileInput').click()" class="btn btn-success">üì§ Import CSV</button>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
            <button onclick="openItemModal()" class="btn btn-primary">+ Add New Item</button>
          </div>
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" onclick="filterItems('All')">All</button>
          <button class="filter-tab" onclick="filterItems('Consultation')">Consultation</button>
          <button class="filter-tab" onclick="filterItems('Laboratory')">Laboratory</button>
          <button class="filter-tab" onclick="filterItems('Procedure')">Procedure</button>
          <button class="filter-tab" onclick="filterItems('Medicine')">Medicine</button>
        </div>

        <div class="card">
          <h3>Items List</h3>
          <table>
            <thead>
              <tr>
                <th>Item ID</th>
                <th>Item Name</th>
                <th>Category</th>
                <th>Unit Price</th>
                <th>Unit</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="itemListBody">
              <tr><td colspan="7" style="text-align: center; color: #999;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- Item Modal -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeItemModal()">&times;</span>
      <h2 id="modalTitle">Add New Item</h2>
      <form id="itemForm" onsubmit="handleItemSubmit(event)">
        <input type="hidden" id="itemId" name="itemId">
        <div class="form-group">
          <label>Item Name *</label>
          <input type="text" name="itemName" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Category *</label>
            <select name="category" required>
              <option value="">Select</option>
              <option value="Consultation">Consultation</option>
              <option value="Laboratory">Laboratory</option>
              <option value="Procedure">Procedure</option>
              <option value="Medicine">Medicine</option>
            </select>
          </div>
          <div class="form-group">
            <label>Unit *</label>
            <select name="unit" required>
              <option value="">Select</option>
              <option value="per visit">per visit</option>
              <option value="per test">per test</option>
              <option value="per session">per session</option>
              <option value="per tablet">per tablet</option>
              <option value="per capsule">per capsule</option>
              <option value="per bottle">per bottle</option>
              <option value="per vial">per vial</option>
              <option value="per piece">per piece</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Unit Price *</label>
            <input type="number" name="unitPrice" required min="0" step="0.01">
          </div>
          <div class="form-group" id="statusGroup" style="display:none;">
            <label>Status</label>
            <select name="status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="2"></textarea>
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button type="submit" class="btn btn-primary">Save Item</button>
          <button type="button" onclick="closeItemModal()" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
      <div id="itemFormMessage"></div>
    </div>
  </div>

  <script>
    let allItems = [];
    let currentFilter = 'All';

    fetch('/api/session').then(r => r.json()).then(user => {
      if (!user) { window.location.href = '/'; return; }
      document.getElementById('userDisplay').textContent = user.name + ' (' + user.role + ')';
      loadItems();
    });

    function handleLogout() {
      fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/');
    }

    function openItemModal(item = null) {
      document.getElementById('itemModal').classList.add('active');
      document.getElementById('itemForm').reset();
      document.getElementById('itemFormMessage').innerHTML = '';
      
      if (item) {
        document.getElementById('modalTitle').textContent = 'Edit Item';
        document.getElementById('statusGroup').style.display = 'block';
        document.getElementById('itemId').value = item.itemId;
        document.querySelector('[name="itemName"]').value = item.itemName;
        document.querySelector('[name="category"]').value = item.category;
        document.querySelector('[name="unit"]').value = item.unit;
        document.querySelector('[name="unitPrice"]').value = item.unitPrice;
        document.querySelector('[name="description"]').value = item.description || '';
        document.querySelector('[name="status"]').value = item.status;
      } else {
        document.getElementById('modalTitle').textContent = 'Add New Item';
        document.getElementById('statusGroup').style.display = 'none';
      }
    }

    function closeItemModal() {
      document.getElementById('itemModal').classList.remove('active');
    }

    function handleItemSubmit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const itemData = {};
      formData.forEach((value, key) => { itemData[key] = value; });
      
      const isEdit = !!itemData.itemId;
      const url = isEdit ? '/api/items/update' : '/api/items/add';
      const method = isEdit ? 'PUT' : 'POST';
      
      document.getElementById('itemFormMessage').innerHTML = '<div class="success-message">Saving...</div>';
      
      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(itemData)
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          document.getElementById('itemFormMessage').innerHTML = 
            '<div class="success-message">‚úì Item saved successfully!</div>';
          setTimeout(() => { closeItemModal(); loadItems(); }, 1500);
        } else {
          document.getElementById('itemFormMessage').innerHTML = 
            '<div class="error-message">Error: ' + result.message + '</div>';
        }
      });
    }

    function loadItems() {
      fetch('/api/items/all')
        .then(r => r.json())
        .then(items => {
          allItems = items;
          displayItems();
        });
    }

    function filterItems(category) {
      currentFilter = category;
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent === category) tab.classList.add('active');
      });
      displayItems();
    }

    function displayItems() {
      const filtered = currentFilter === 'All' 
        ? allItems 
        : allItems.filter(i => i.category === currentFilter);
      
      const tbody = document.getElementById('itemListBody');
      if (!filtered || filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No items found</td></tr>';
        return;
      }
      
      let html = '';
      filtered.forEach(i => {
        html += '<tr>';
        html += '<td>' + i.itemId + '</td>';
        html += '<td>' + i.itemName + '</td>';
        html += '<td>' + i.category + '</td>';
        html += '<td>‚Ç±' + parseFloat(i.unitPrice).toFixed(2) + '</td>';
        html += '<td>' + i.unit + '</td>';
        html += '<td><span style="color: ' + (i.status === 'Active' ? 'green' : 'red') + '">' + i.status + '</span></td>';
        html += '<td><button onclick=\'editItem(' + JSON.stringify(i) + ')\' class="btn btn-sm btn-primary">Edit</button></td>';
        html += '</tr>';
      });
      tbody.innerHTML = html;
    }

    function editItem(item) {
      openItemModal(item);
    }

    // CSV Export Function
    function exportToCSV() {
      if (allItems.length === 0) {
        alert('No items to export');
        return;
      }

      // Create CSV header
      const headers = ['Item ID', 'Item Name', 'Category', 'Unit Price', 'Unit', 'Description', 'Status'];
      let csv = headers.join(',') + '\n';

      // Add data rows
      allItems.forEach(item => {
        const row = [
          item.itemId,
          '"' + (item.itemName || '').replace(/"/g, '""') + '"',
          item.category,
          item.unitPrice,
          item.unit,
          '"' + (item.description || '').replace(/"/g, '""') + '"',
          item.status
        ];
        csv += row.join(',') + '\n';
      });

      // Create download link
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'items_pricing_' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      alert('Items exported successfully!');
    }

    // CSV Import Function
    function importFromCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        
        if (lines.length < 2) {
          alert('CSV file is empty or invalid');
          return;
        }

        // Skip header row
        const dataLines = lines.slice(1).filter(line => line.trim());
        
        if (dataLines.length === 0) {
          alert('No data found in CSV file');
          return;
        }

        const itemsToImport = [];
        let errors = [];

        dataLines.forEach((line, index) => {
          // Parse CSV line (handle quoted fields)
          const fields = parseCSVLine(line);
          
          if (fields.length < 5) {
            errors.push('Line ' + (index + 2) + ': Insufficient fields');
            return;
          }

          const itemData = {
            itemName: fields[1] || '',
            category: fields[2] || '',
            unitPrice: parseFloat(fields[3]) || 0,
            unit: fields[4] || '',
            description: fields[5] || '',
            status: fields[6] || 'Active'
          };

          // Validate required fields
          if (!itemData.itemName || !itemData.category || !itemData.unit) {
            errors.push('Line ' + (index + 2) + ': Missing required fields');
            return;
          }

          itemsToImport.push(itemData);
        });

        if (errors.length > 0) {
          alert('Import errors:\n' + errors.join('\n'));
          return;
        }

        if (itemsToImport.length === 0) {
          alert('No valid items to import');
          return;
        }

        // Confirm import
        if (!confirm('Import ' + itemsToImport.length + ' items? This will add new items to the database.')) {
          return;
        }

        // Import items one by one
        importItemsBatch(itemsToImport, 0);
      };

      reader.readAsText(file);
      event.target.value = ''; // Reset file input
    }

    function parseCSVLine(line) {
      const fields = [];
      let field = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            field += '"';
            i++; // Skip next quote
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          fields.push(field.trim());
          field = '';
        } else {
          field += char;
        }
      }
      fields.push(field.trim());
      return fields;
    }

    function importItemsBatch(items, index) {
      if (index >= items.length) {
        alert('Import completed! ' + items.length + ' items imported successfully.');
        loadItems();
        return;
      }

      fetch('/api/items/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(items[index])
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          // Import next item
          importItemsBatch(items, index + 1);
        } else {
          alert('Error importing item at line ' + (index + 2) + ': ' + result.message);
        }
      })
      .catch(error => {
        alert('Error importing item at line ' + (index + 2) + ': ' + error.message);
      });
    }
  </script>
</body>
</html>

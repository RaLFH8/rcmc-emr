<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Portal - Rizalcare EMR</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .portal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .portal-header h1 { margin: 0 0 10px 0; }
    .portal-header p { margin: 0; opacity: 0.9; }
    .info-card { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .info-card h4 { margin: 0 0 10px 0; color: var(--primary-color); }
    .info-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; margin-bottom: 8px; }
    .info-label { font-weight: 500; color: #666; }
    .consultation-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .consultation-card h4 { margin: 0 0 10px 0; color: var(--primary-color); }
    .vital-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0; }
    .vital-item { background: #f5f5f5; padding: 8px; border-radius: 4px; text-align: center; }
    .vital-label { font-size: 11px; color: #666; }
    .vital-value { font-size: 16px; font-weight: 600; color: #333; }
  </style>
</head>
<body>
  <div class="main-app">
    <nav class="top-nav">
      <div class="nav-left">
        <div class="clinic-name">üè• Rizalcare Medical Clinic - Patient Portal</div>
      </div>
      <div class="nav-right">
        <span id="userDisplay"></span>
        <button onclick="handleLogout()" class="btn btn-secondary btn-sm">Logout</button>
      </div>
    </nav>

    <div class="main-layout">
      <aside class="sidebar">
        <ul class="menu">
          <li class="menu-item active"><a href="#" onclick="showSection('profile')">üë§ My Profile</a></li>
          <li class="menu-item"><a href="#" onclick="showSection('appointments')">üìÖ My Appointments</a></li>
          <li class="menu-item"><a href="#" onclick="showSection('consultations')">ü©∫ Medical History</a></li>
          <li class="menu-item"><a href="#" onclick="showSection('billing')">üí≥ Billing</a></li>
        </ul>
      </aside>

      <main class="content-area">
        <!-- Profile Section -->
        <div id="profileSection">
          <div class="portal-header">
            <h1 id="patientName">Loading...</h1>
            <p id="patientId"></p>
          </div>

          <div class="card">
            <h3>Personal Information</h3>
            <div id="personalInfo"></div>
          </div>

          <div class="card">
            <h3>Medical Information</h3>
            <div id="medicalInfo"></div>
          </div>

          <div class="card">
            <h3>Emergency Contact</h3>
            <div id="emergencyInfo"></div>
          </div>
        </div>

        <!-- Appointments Section -->
        <div id="appointmentsSection" style="display: none;">
          <h1>My Appointments</h1>
          <div class="card">
            <h3>Upcoming Appointments</h3>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Doctor</th>
                  <th>Purpose</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="appointmentsList">
                <tr><td colspan="5" style="text-align: center; color: #999;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Consultations Section -->
        <div id="consultationsSection" style="display: none;">
          <h1>Medical History</h1>
          <div id="consultationsList"></div>
        </div>

        <!-- Billing Section -->
        <div id="billingSection" style="display: none;">
          <h1>Billing & Payments</h1>
          <div class="card">
            <h3>Recent Invoices</h3>
            <p style="color: #999; text-align: center; padding: 20px;">Billing module coming soon</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    let currentPatient = null;

    // Check if logged in and get patient data
    fetch('/api/session').then(r => r.json()).then(user => {
      if (!user) { window.location.href = '/'; return; }
      document.getElementById('userDisplay').textContent = user.name;
      
      // For demo, we'll use the first patient. In production, link user to patient record
      loadPatientData();
    });

    function handleLogout() {
      fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/');
    }

    function showSection(section) {
      document.getElementById('profileSection').style.display = 'none';
      document.getElementById('appointmentsSection').style.display = 'none';
      document.getElementById('consultationsSection').style.display = 'none';
      document.getElementById('billingSection').style.display = 'none';
      
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      event.target.closest('.menu-item').classList.add('active');
      
      if (section === 'profile') {
        document.getElementById('profileSection').style.display = 'block';
      } else if (section === 'appointments') {
        document.getElementById('appointmentsSection').style.display = 'block';
        loadAppointments();
      } else if (section === 'consultations') {
        document.getElementById('consultationsSection').style.display = 'block';
        loadConsultations();
      } else if (section === 'billing') {
        document.getElementById('billingSection').style.display = 'block';
      }
    }

    function loadPatientData() {
      // For demo, load first patient. In production, get patient ID from user session
      fetch('/api/patients/all')
        .then(r => r.json())
        .then(patients => {
          if (patients.length > 0) {
            const patientId = patients[0].patientId;
            fetch('/api/patients/' + patientId)
              .then(r => r.json())
              .then(patient => {
                currentPatient = patient;
                displayPatientInfo(patient);
              });
          }
        });
    }

    function displayPatientInfo(patient) {
      document.getElementById('patientName').textContent = patient.firstName + ' ' + patient.lastName;
      document.getElementById('patientId').textContent = 'Patient ID: ' + patient.patientId;
      
      document.getElementById('personalInfo').innerHTML = `
        <div class="info-row"><div class="info-label">Full Name:</div><div>${patient.firstName} ${patient.lastName}</div></div>
        <div class="info-row"><div class="info-label">Date of Birth:</div><div>${patient.dateOfBirth || 'N/A'}</div></div>
        <div class="info-row"><div class="info-label">Gender:</div><div>${patient.gender || 'N/A'}</div></div>
        <div class="info-row"><div class="info-label">Contact Number:</div><div>${patient.contactNumber || 'N/A'}</div></div>
        <div class="info-row"><div class="info-label">Email:</div><div>${patient.email || 'N/A'}</div></div>
        <div class="info-row"><div class="info-label">Address:</div><div>${patient.address || 'N/A'}</div></div>
      `;
      
      document.getElementById('medicalInfo').innerHTML = `
        <div class="info-row"><div class="info-label">Blood Type:</div><div>${patient.bloodType || 'N/A'}</div></div>
        <div class="info-row"><div class="info-label">Allergies:</div><div>${patient.allergies || 'None'}</div></div>
        <div class="info-row"><div class="info-label">Medical History:</div><div>${patient.medicalHistory || 'None'}</div></div>
      `;
      
      document.getElementById('emergencyInfo').innerHTML = `
        <div class="info-row"><div class="info-label">Contact Person:</div><div>${patient.emergencyContact || 'N/A'}</div></div>
        <div class="info-row"><div class="info-label">Contact Number:</div><div>${patient.emergencyNumber || 'N/A'}</div></div>
      `;
    }

    function loadAppointments() {
      if (!currentPatient) return;
      
      // Get all appointments for this patient
      fetch('/api/appointments/patient/' + currentPatient.patientId)
        .then(r => r.json())
        .then(appointments => {
          const tbody = document.getElementById('appointmentsList');
          if (!appointments || appointments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No appointments found</td></tr>';
            return;
          }
          
          let html = '';
          appointments.forEach(apt => {
            html += '<tr>';
            html += '<td>' + apt.appointmentDate + '</td>';
            html += '<td>' + apt.appointmentTime + '</td>';
            html += '<td>' + apt.doctorName + '</td>';
            html += '<td>' + apt.purpose + '</td>';
            html += '<td><span class="badge badge-' + apt.status.toLowerCase() + '">' + apt.status + '</span></td>';
            html += '</tr>';
          });
          tbody.innerHTML = html;
        });
    }

    function loadConsultations() {
      if (!currentPatient) return;
      
      fetch('/api/consultations/patient/' + currentPatient.patientId)
        .then(r => r.json())
        .then(consultations => {
          const container = document.getElementById('consultationsList');
          if (!consultations || consultations.length === 0) {
            container.innerHTML = '<div class="card"><p style="text-align: center; color: #999;">No consultation records found</p></div>';
            return;
          }
          
          let html = '';
          consultations.forEach(con => {
            const vitals = JSON.parse(con.vitalSigns || '{}');
            const date = new Date(con.consultationDate).toLocaleDateString();
            
            html += '<div class="consultation-card">';
            html += '<h4>Consultation - ' + date + '</h4>';
            html += '<p><strong>Doctor:</strong> ' + con.doctorName + '</p>';
            html += '<p><strong>Chief Complaint:</strong> ' + con.chiefComplaint + '</p>';
            
            if (vitals.bp || vitals.temp || vitals.hr) {
              html += '<div class="vital-grid">';
              if (vitals.bp) html += '<div class="vital-item"><div class="vital-label">BP</div><div class="vital-value">' + vitals.bp + '</div></div>';
              if (vitals.temp) html += '<div class="vital-item"><div class="vital-label">Temp</div><div class="vital-value">' + vitals.temp + '¬∞C</div></div>';
              if (vitals.hr) html += '<div class="vital-item"><div class="vital-label">HR</div><div class="vital-value">' + vitals.hr + '</div></div>';
              if (vitals.weight) html += '<div class="vital-item"><div class="vital-label">Weight</div><div class="vital-value">' + vitals.weight + ' kg</div></div>';
              html += '</div>';
            }
            
            html += '<p><strong>Diagnosis:</strong> ' + con.diagnosis + '</p>';
            html += '<p><strong>Treatment Plan:</strong> ' + con.treatmentPlan + '</p>';
            
            if (con.prescription) {
              html += '<p><strong>Prescription:</strong></p>';
              html += '<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;">' + con.prescription + '</pre>';
            }
            
            if (con.followUpDate) {
              html += '<p><strong>Follow-up Date:</strong> ' + con.followUpDate + '</p>';
            }
            
            html += '</div>';
          });
          container.innerHTML = html;
        });
    }
  </script>
</body>
</html>
